# Scriptify Slash Command 架构设计

**重要说明**: 本文档基于 article-writer 的架构设计原则

---

## 核心架构

```
┌─────────────────────────────────────┐
│   Markdown 指令层                    │
│   - 定义AI角色和边界                  │
│   - 用自然语言描述检查标准             │
│   - 说明工作流程原则                  │
│   - 引用bash脚本                     │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│   AI 执行层                          │
│   - 读取并理解markdown标准            │
│   - 根据上下文灵活判断                │
│   - 调用bash脚本处理文件              │
│   - 生成个性化反馈                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│   Bash 脚本层                        │
│   - 文件和目录管理                    │
│   - 项目检测和创建                    │
│   - 字数统计                          │
│   - 输出JSON供AI使用                 │
└─────────────────────────────────────┘
```

---

## 层次职责

### 1. Markdown指令层(模板)

**位置**: `templates/commands/*.md`

**职责**:
- 定义AI的角色和边界
- 用自然语言描述检查标准
- 说明工作流程(原则,非具体对话)
- 引用需要的bash脚本

**示例**(YAML frontmatter):

```yaml
---
description: AI教练引导用户构思剧本创意(用户必须自己思考)
argument-hint: [可选:剧本类型]
allowed-tools: Read(//projects/*/spec.json), Write(//projects/*/outline.md)
scripts:
  sh: scripts/bash/idea.sh
---

# /idea - 构思故事创意

## AI 角色

你是一位专业的剧本创作教练。你的职责是**引导用户自己构思故事创意**,而不是替用户想创意。

## 检查标准

用户的故事核心应该包含:

1. **清晰的主角**: 有具体的职业/年龄/性格
2. **明确的目标**: 主角想要达成什么?
3. **真实的障碍**: 什么阻止主角达成目标?
4. **性格缺陷**: 主角有什么弱点?
5. **成长弧线**: 主角从A点到B点的转变

## 工作流程原则

1. 通过提问引导用户思考,而不是直接给答案
2. 如果用户回答模糊,追问细节
3. 如果用户的设定有明显问题,指出问题并引导优化
4. 在所有问题回答完后,总结故事核心

## 禁止行为

- ❌ 不要替用户想创意
- ❌ 不要生成完整的故事构思
- ❌ 不要机械地照本宣科执行预设问题列表

## 脚本调用

执行前先调用:
```bash
bash scripts/bash/idea.sh [项目路径]
```

脚本会返回JSON:
```json
{
  "project_path": "/path/to/project",
  "spec": { ... },
  "existing_idea": null
}
```

根据JSON结果调整引导策略。
```

**不应该包含**:
- ❌ "AI: ..."、"用户: ..."的对话脚本
- ❌ 硬编码的问题列表
- ❌ 预设的反馈文本

---

### 2. AI执行层

**职责**:
- 读取markdown指令
- 理解检查标准和原则
- 根据具体内容灵活判断
- 调用bash脚本处理文件操作
- 生成针对性的反馈

**不应该做**:
- ❌ 机械匹配关键词
- ❌ 照本宣科执行预设流程
- ❌ 直接操作文件系统(应通过bash脚本)

---

### 3. Bash脚本层

**位置**: `scripts/bash/*.sh`

**职责**:
- 文件和目录操作
- 项目管理
- 字数统计
- 输出JSON供AI读取

**核心脚本**:

**`common.sh`** - 通用函数库:
```bash
get_project_root()        # 获取项目根目录
get_current_project()     # 获取当前项目
count_chinese_words()     # 准确的中文字数统计
output_json()             # 输出JSON
```

**`new.sh`** - 创建项目:
```bash
# 创建项目目录结构
# 初始化项目文件
# 输出JSON供AI使用
```

**`spec.sh`** - 定义剧本规格:
```bash
# 保存剧本规格到 spec.json
# 检测规格合法性
# 输出JSON
```

**`idea.sh`** - 构思创意:
```bash
# 加载项目规格
# 检查是否已有创意
# 输出JSON
```

**设计原则**:
- 纯工具函数,无业务逻辑
- 输出JSON格式供AI解析
- 跨平台兼容

---

## 命令执行流程示例

### 示例: `/idea` 命令

**1. 用户执行**:
```bash
/idea
```

**2. AI读取模板**:
- 读取 `templates/commands/idea.md`
- 理解角色: 剧本创作教练
- 理解边界: forbidden(不能替用户想创意)
- 看到引用脚本: `scripts/bash/idea.sh`

**3. AI调用bash脚本**:
```bash
bash scripts/bash/idea.sh
```

**4. Bash脚本执行**:
- 检测当前项目
- 加载项目规格
- 检查是否已有创意
- 输出JSON:
```json
{
  "project_path": "/path/to/心理游戏",
  "spec": {
    "type": "短剧",
    "duration": "10分钟×10集",
    "genre": ["悬疑", "言情"],
    "audience": "25-35岁女性"
  },
  "existing_idea": null
}
```

**5. AI解析JSON**:
- 知道项目路径
- 知道剧本规格(短剧,悬疑+言情)
- 知道目标受众(25-35岁女性)
- 知道还没有创意构思

**6. AI开始引导**(灵活执行,非照本宣科):
- 根据markdown中的原则和检查标准提问
- 根据剧本规格(悬疑+言情)调整提问方向
- 等待用户思考和回答
- 检查用户回答是否符合标准
- 如果回答模糊,追问细节
- 生成个性化反馈

**示例对话**(AI根据理解灵活生成,非预设):

```
AI: 我看到你的剧本定位是"悬疑+言情"短剧,面向25-35岁女性观众。
    让我们一起构思故事的核心。

    首先,你想到的主角是谁?可以描述一下他/她的职业、年龄、性格。

用户: 一个心理咨询师,28岁

AI: 心理咨询师很有意思,这个职业容易挖掘人性和心理层面的故事。

    这位28岁的心理咨询师,她叫什么名字?她的性格是怎样的?
    比如,她是理性冷静型?还是感性敏感型?

用户: 林悦,表面理性但内心脆弱

AI: 很好的对比设定!"表面理性但内心脆弱"给了角色很强的戏剧张力。

    那么,林悦最想要达成什么目标?这个目标驱动整个故事。

用户: 她想找出一个连环杀手

AI: 悬疑核心出来了!一个心理咨询师追查连环杀手。

    但有个关键问题:为什么她要找杀手?
    她不是警察,为什么要主动卷入这件事?是有私人原因吗?

用户: 因为杀手杀了她的闺蜜

AI: 理解了,这是个人复仇动机,非常强烈。
    "闺蜜被害" + "心理咨询师" 的组合很有潜力。

    现在来思考障碍:什么阻止林悦找到杀手?

...
(对话继续,AI灵活引导,直到完成所有核心要素)
```

---

## 为什么这样设计?

### 1. 利用bash脚本的优势

**Bash擅长**:
- 文件和目录操作
- 项目检测
- 跨进程调用
- 输出格式化数据

**TypeScript不擅长**(在命令行环境):
- 需要编译
- 依赖node_modules
- 跨平台兼容性问题

### 2. 避免重复实现

已有的bash脚本非常完善:
- 准确的中文字数统计(去除markdown标记)
- 项目自动检测
- 编号目录管理
- JSON输出

不需要用TypeScript重新实现一遍。

### 3. 符合slash command理念

Slash command的本质:
- **配置化**: 用YAML配置引用脚本
- **灵活性**: AI根据指令灵活执行
- **工具化**: 调用外部工具处理具体任务

### 4. 可扩展性

添加新命令只需要:
1. 创建markdown模板(指令)
2. 创建bash脚本(工具)
3. 在YAML中引用

不需要写TypeScript代码。

---

## Scriptify 命令设计原则

基于以上架构,Scriptify的30+命令应该遵循:

### 原则1: Markdown定义"做什么"(标准)

```markdown
# /review - 剧本质量评估

## AI 角色
你是一位专业的剧本评审专家。

## 评估标准

四维度评分:
1. **结构完整性**: 检查三幕式结构、关键节点是否完整
2. **人物立体度**: 评估人物动机、冲突、成长弧线
3. **对话质量**: 检查口语化、潜台词、推动剧情
4. **节奏控制**: 评估张弛有度、爆点密度

## 评分原则

- 每个维度0-100分
- 总分 = 结构30% + 人物25% + 对话25% + 节奏20%
- 90-100: 优秀,可直接拍摄
- 75-89: 良好,小幅优化
- 60-74: 及格,需要改进
- <60: 不合格

## 反馈要求

- 具体指出问题场景和行号
- 给出优化建议(而不是直接修改)
- 标注高中低优先级

## 禁止行为

- ❌ 不要直接修改剧本
- ❌ 不要生成完整的优化版本
```

**不是这样**:
```markdown
❌ 错误示例:

AI: 正在评估剧本...

✅ 结构完整性评分: 82/100

📊 详细分析:

【三幕式结构】
  ✓ 第一幕 (0:00-2:30, 25%) - 比例合理
  ...
```

### 原则2: AI决定"怎么做"(灵活执行)

AI根据:
- Markdown中的标准
- Bash脚本返回的JSON
- 用户的具体剧本内容

灵活生成评估报告,而不是照搬模板。

### 原则3: Bash执行"具体操作"(工具)

```bash
#!/usr/bin/env bash
# scripts/bash/review.sh

# 获取剧本文件
SCRIPT_FILE="$1"

# 统计字数、场景数、对话数
WORD_COUNT=$(count_chinese_words "$SCRIPT_FILE")
SCENE_COUNT=$(grep -c "^## 场景" "$SCRIPT_FILE")
DIALOGUE_COUNT=$(grep -c "^[A-Za-z]" "$SCRIPT_FILE")

# 输出JSON供AI分析
output_json "{
  \"file\": \"$SCRIPT_FILE\",
  \"word_count\": $WORD_COUNT,
  \"scene_count\": $SCENE_COUNT,
  \"dialogue_count\": $DIALOGUE_COUNT
}"
```

---

## 验收标准

一个正确的Scriptify命令系统应该:

- [ ] ✅ 所有命令模板都有YAML frontmatter
- [ ] ✅ YAML中正确引用bash脚本
- [ ] ✅ Markdown用自然语言描述标准,无对话脚本
- [ ] ✅ Bash脚本输出JSON供AI解析
- [ ] ✅ 无TypeScript工具函数重复实现
- [ ] ✅ AI根据markdown标准+bash输出灵活执行

---

## PRD修正说明

**原PRD-06的问题**:

1. ❌ 硬编码了大量对话示例(AI: ... 用户: ...)
2. ❌ 预设了具体的问题列表和反馈文本
3. ❌ 没有说明bash脚本层的职责
4. ❌ 没有体现AI的灵活执行能力

**正确的做法**:

1. ✅ Markdown只定义标准、原则、边界
2. ✅ 给AI足够的灵活空间
3. ✅ 通过bash脚本处理文件操作
4. ✅ 让AI根据具体情况生成个性化反馈

**PRD-06应该改为**:

- 描述每个命令的"检查标准"和"工作流程原则"
- 说明需要哪些bash脚本和JSON输出格式
- 提供1-2个示例说明AI如何灵活执行
- 不要硬编码对话流程

---

## 总结

| 层次 | 技术 | 职责 | 不应该做 |
|---|---|---|---|
| **指令层** | Markdown | 定义标准和原则 | 硬编码对话 |
| **执行层** | AI | 理解+判断+调用工具 | 机械匹配 |
| **工具层** | Bash | 文件操作+输出JSON | 业务逻辑 |

**核心原则**:
> Markdown定义"做什么"(标准)
> AI决定"怎么做"(灵活执行)
> Bash执行"具体操作"(工具)

---

**下一步行动**:
- [ ] 修正PRD-06,移除硬编码对话
- [ ] 为每个命令定义检查标准和原则
- [ ] 设计bash脚本的JSON输出格式
- [ ] 创建 `templates/commands/*.md` 模板文件
- [ ] 实现 `scripts/bash/*.sh` 脚本文件

---

**参考文档**:
- `other/article-writer/docs/slash-command-architecture.md`
- `other/article-writer/templates/commands/`
- `other/article-writer/scripts/bash/`
